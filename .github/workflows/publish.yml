name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    name: Build on ${{ matrix.TARGET_OS }} (${{ matrix.ARCH }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # 1. Windows 64位
          - os: windows-latest
            TARGET_OS: windows
            ARCH: x64
            PYTHON_ARCH: x64  # 指定 64位 Python
            EXECUTABLE: extract_answers.exe
            ASSET_NAME: extract_answers_windows_x64.exe
            
          # 2. Windows 32位 (新增)
          - os: windows-latest
            TARGET_OS: windows
            ARCH: x86_32
            PYTHON_ARCH: x86  # 核心改动：强制安装 32位 Python
            EXECUTABLE: extract_answers.exe
            ASSET_NAME: extract_answers_windows_x86_32.exe
            
          # 3. macOS Intel
          - os: macos-13
            TARGET_OS: macos
            ARCH: intel_x86_64
            PYTHON_ARCH: x64
            EXECUTABLE: extract_answers
            ASSET_NAME: extract_answers_macos_intel_x86_64
            
          # 4. macOS ARM (M系列芯片)
          - os: macos-14
            TARGET_OS: macos
            ARCH: apple_silicon_arm64
            PYTHON_ARCH: x64
            EXECUTABLE: extract_answers
            ASSET_NAME: extract_answers_macos_apple_silicon_arm64

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    # ==========================================
    # 核心改动：根据矩阵变量，动态拉取对应架构的 Python
    # ==========================================
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.14'
        architecture: ${{ matrix.PYTHON_ARCH }} 

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas beautifulsoup4 openpyxl pyinstaller

    - name: Build with PyInstaller
      run: |
        pyinstaller --onefile extract_answers.py

    - name: Prepare Asset for Release
      shell: bash
      run: |
        cd dist
        if [ "${{ matrix.TARGET_OS }}" == "windows" ]; then
          mv ${{ matrix.EXECUTABLE }} ${{ matrix.ASSET_NAME }}
        else
          mv ${{ matrix.EXECUTABLE }} ${{ matrix.ASSET_NAME }}
          chmod +x ${{ matrix.ASSET_NAME }}
          zip ${{ matrix.ASSET_NAME }}.zip ${{ matrix.ASSET_NAME }}
        fi

    - name: Upload to GitHub Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: dist/${{ matrix.ASSET_NAME }}*
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
